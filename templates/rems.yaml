---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.name | default "rems" }}
  labels:
    app: {{ .Values.name | default "rems" }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ .Values.name | default "rems" }}
  template:
    metadata:
      name: {{ .Values.name | default "rems" }}
      labels:
        app: {{ .Values.name | default "rems" }}
    spec:
      initContainers:
      {{- if .Values.postgres.dbConnection.wait }}
      - name: database-wait
        image: {{ .Values.postgres.image.name }}:{{ .Values.postgres.image.tag }}
        imagePullPolicy: {{ .Values.postgres.image.pullPolicy }}
        command:
        - sh
        - -c
        - |
          until timeout 1 psql -v ON_ERROR_STOP=1 \
                               -h {{ .Values.postgres.dbConnection.hostname }} \
                               -U {{ .Values.postgres.dbConnection.user }} \
                               -d {{ .Values.postgres.dbConnection.name }} \
                               -c "SELECT 1" -w 1> /dev/null
          do
            echo "Waiting for database to accept connections"
            sleep 2
          done
          echo "Database connection found"
        env:
        - name: PGPASSWORD
          value: {{ .Values.postgres.dbConnection.password | quote }}
      {{- end }}
      {{- if .Values.migrate }}
      - name: database-migrate
        image: {{ .Values.image.rems.name }}:{{ .Values.image.rems.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy | default "Always" | quote }}
        env:
        - name: COMMANDS
          value: "migrate"
        - name: CMD
          value: "migrate"
        volumeMounts:
        - name: init-config
          mountPath: /rems/config
      {{- end }}
      {{- if .Values.postgres.dbConnection.addData }}
      - name: database-add-data
        image: {{ .Values.image.rems.name }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy | default "Always" | quote }}
        env:
        - name: COMMANDS
          value: {{ .Values.postgres.dbConnection.addDataType | default "test-data" | quote }}
        - name: CMD
          value: {{ .Values.postgres.dbConnection.addDataType | default "test-data" | quote }}
        volumeMounts:
        - name: init-config
          mountPath: /rems/config
      {{- end }}
      {{- if .Values.extraCommands }}
      - name: extra-commands
        image: {{ .Values.image.rems.name }}:{{ .Values.image.rems.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy | default "Always" | quote }}
        env:
        - name: CMD
          value: {{ .Values.extraCommands | quote }}
        volumeMounts:
        - name: init-config
          mountPath: /rems/config
      {{- end }}
      containers:
      - name: {{ .Values.name | default "rems" }}
        image: {{ .Values.image.rems.name }}:{{ .Values.image.rems.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy | default "Always" | quote }}
        {{- if not (.Values.run) }}
        command: ["sh", "-c", "exit 0"]
        {{- end }}
        ports:
        - containerPort: {{ .Values.port | default "3001" }}
          name: rems
        volumeMounts:
        - name: config
          mountPath: /rems/config
        {{- $img := .Files.Glob "files/img/*" }}
        {{- $trans := .Files.Glob "files/extra-translations/*" }}
        {{- $keys := .Files.Glob "files/keys/*" }}
        {{- $db_tls := .Files.Glob "files/db-tls/*" }}
        {{- if .Values.theme.create }}
        - name: theme
          mountPath: /rems/theme
          {{- if $img }}
        - name: img
          mountPath: /rems/theme/public/img
          {{- end }}
          {{- if $trans }}
        - name: extra-translations
          mountPath: /rems/theme/extra-translations
          {{- end }}
        {{- end }}
        {{- if .Values.extrapages.create }}
        - name: extra-pages
          mountPath: /rems/extra-pages
        {{- end }}
        {{- if .Values.certs.create }}
        - name: certs
          mountPath: /rems/certs
        {{- end }}
        {{- if $keys }}
        - name: keys
          mountPath: /rems/keys
        {{- end }}
        {{- if $db_tls }}
          {{- if .Values.postgres.dbConnection.tls }}
        - name: db-tls
          mountPath: /rems/db-tls
          {{- end }}
        {{- end }}
        {{- if .Values.readOnlyFilesystem }}
        - name: tmp
          mountPath: /tmp
        {{- end }}
      volumes:
      - name: config
        configMap:
          name: {{ .Values.name | default "rems" }}-config
      - name: init-config
        configMap:
          name: {{ .Values.name | default "rems" }}-init-config
      {{- if .Values.theme.create }}
      - name: theme
        configMap:
          name:  {{ .Values.name | default "rems" }}-theme
        {{- if $img }}
      - name: img
        configMap:
          name: {{ .Values.name | default "rems" }}-img
        {{- end }}
        {{- if $trans  }}
      - name: extra-translations
        configMap:
          name: {{ .Values.name | default "rems" }}-extra-translations
        {{- end }}
      {{- end }}
      {{- if .Values.extrapages.create }}
      - name: extra-pages
        configMap:
          name: {{ .Values.name | default "rems" }}-extra-pages
      {{- end }}
      {{- if .Values.certs.create }}
      - name: certs
        configMap:
          name: {{ .Values.name | default "rems" }}-certs
      {{- end }}
      {{- if $keys }}
      - name: keys
        secret:
          secretName: {{ .Values.name | default "rems" }}-keys
      {{- end }}
      {{- if $db_tls }}
      - name: db-tls
        secret:
          secretName: {{ .Values.name | default "rems" }}-db-tls
      {{- end }}
      {{- if .Values.readOnlyFilesystem }}
      - name: tmp
        emptyDir: {}
      {{- end }}
